# π”’ sping-boot-tdd λ™μ‹μ„± μ μ–΄ ν¬μΈνΈ μ‹μ¤ν…

Spring Boot κΈ°λ°μ ν¬μΈνΈ κ΄€λ¦¬ μ‹μ¤ν…μΌλ΅, **λ™μ‹μ„± μ μ–΄**μ— μ¤‘μ μ„ λ‘” μ•μ „ν• λ©€ν‹°μ¤λ λ“ ν™κ²½μ—μ„μ ν¬μΈνΈ μ¶©μ „/μ‚¬μ© μ„λΉ„μ¤μ…λ‹λ‹¤.

---

## π“ ν”„λ΅μ νΈ κ°μ”

μ‚¬μ©μλ³„ ν¬μΈνΈ μ‹μ¤ν…μ„ κµ¬ν„ν• λ°±μ—”λ“ μ„λΉ„μ¤λ΅, μ¶©μ „, μ‚¬μ©, μ΅°ν, λ‚΄μ—­ μ΅°νμ 4κ°€μ§€ κΈ°λ¥μ„ μ κ³µν•©λ‹λ‹¤.

**ν•µμ‹¬ νΉμ§•:**

- π” **Thread-Safe λ™μ‹μ„± μ μ–΄**: ReentrantLock κΈ°λ° μ‚¬μ©μλ³„ λ½ κ΄€λ¦¬
- π—οΈ **DDD + Layered Architecture**: λ„λ©”μΈ μ¤‘μ‹¬ μ„¤κ³„μ™€ κ³„μΈµ λ¶„λ¦¬
- β™οΈ **Spring Property μ™Έλ¶€ν™”**: μ΄μ μ¤‘ μ •μ±… λ³€κ²½ κ°€λ¥
- π§ **TDD κΈ°λ° κ°λ°**: ν…μ¤νΈ μ£Όλ„ κ°λ°λ΅ μ‹ λΆ°μ„± ν™•λ³΄

---

## π― μ£Όμ” ν•΄κ²° κ³Όμ 

### λ™μ‹μ„± λ¬Έμ  ν•΄κ²°

- **Lost Update Problem**: λ™μ‹ μ”μ²­ μ‹ κ°±μ‹  μ†μ‹¤ λ°©μ§€
- **Race Condition**: κ²½μ μ΅°κ±΄μΌλ΅ μΈν• λ°μ΄ν„° λ¶μΌμΉ ν•΄κ²°
- **μµλ€ ν•λ„ κ²€μ¦**: λ™μ‹ μ¶©μ „μΌλ΅ μΈν• ν•λ„ μ΄κ³Ό λ°©μ§€

### ν•΄κ²° λ°©μ•

```java
// ReentrantLock κΈ°λ° μ‚¬μ©μλ³„ λ™μ‹μ„± μ μ–΄
public UserPoint charge(long userId, long amount) {
    ReentrantLock lock = getUserLock(userId);
    lock.lock();
    try {
        // μ›μμ  μ—°μ‚°: μ΅°ν β†’ κ²€μ¦ β†’ μ—…λ°μ΄νΈ β†’ κΈ°λ΅
        return processCharge(userId, amount);
    } finally {
        lock.unlock();
    }
}
```

---

## π—οΈ μ•„ν‚¤ν…μ² μ„¤κ³„

### Layered Architecture + DDD

```
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Presentation Layer                  β”‚ β† HTTP μ”μ²­/μ‘λ‹µ μ²λ¦¬
β”‚ β”β”€β”€ PointController.java            β”‚
β”‚ β””β”€β”€ ApiControllerAdvice.java        β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
            β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Application Layer                   β”‚ β† λΉ„μ¦λ‹μ¤ ν”λ΅μ° μ΅°μ •
β”‚ β””β”€β”€ PointService.java               β”‚ β† λ™μ‹μ„± μ μ–΄ μ μ©
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
            β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Domain Layer                        β”‚ β† λ„λ©”μΈ λ΅μ§ & μ •μ±…
β”‚ β”β”€β”€ UserPoint.java                  β”‚
β”‚ β”β”€β”€ PointHistory.java               β”‚
β”‚ β”β”€β”€ ChargePolicy.java               β”‚
β”‚ β””β”€β”€ UsePolicy.java                  β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
            β†“
β”β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
β”‚ Infrastructure Layer                β”‚ β† λ°μ΄ν„° μ €μ¥μ†
β”‚ β”β”€β”€ UserPointTable.java             β”‚
β”‚ β””β”€β”€ PointHistoryTable.java          β”‚
β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”€β”
```

---

## β–οΈ λΉ„μ¦λ‹μ¤ μ •μ±… (μ„¤μ • κΈ°λ°)

### μ •μ±… μ„¤μ • (application.yml)

```yaml
point:
  policy:
    charge:
      min-amount: 100 # μµμ† μ¶©μ „ κΈμ•΅
      max-total-point: 1000000 # μµλ€ λ³΄μ  ν¬μΈνΈ
    use:
      min-amount: 100 # μµμ† μ‚¬μ© κΈμ•΅
  concurrency:
    max-locks: 10000 # μµλ€ λ½ κ°μ
    cleanup-interval: 3600000 # λ½ μ •λ¦¬ μ£ΌκΈ° (1μ‹κ°„)
```

### μ£Όμ” μ •μ±…

| μ •μ±… ν•­λ©        | μ„¤μ •κ°’      | μ„¤λ…                       |
| ---------------- | ----------- | -------------------------- |
| μµλ€ λ³΄μ  ν¬μΈνΈ | 1,000,000μ› | ν• μ‚¬μ©μλ‹Ή μµλ€ λ³΄μ  κ°€λ¥ |
| μµμ† κ±°λ κΈμ•΅   | 100μ›       | μ¶©μ „/μ‚¬μ© μµμ† λ‹¨μ„        |
| λ™μ‹μ„± μ μ–΄      | μ‚¬μ©μλ³„ λ½ | λ™μΌ μ‚¬μ©μλ” μμ°¨ μ²λ¦¬    |

---

## π”’ λ™μ‹μ„± μ μ–΄ μ „λµ

### ReentrantLock λ°©μ‹ μ„ νƒ μ΄μ 

| νΉμ§•                  | synchronized | **ReentrantLock** | AtomicLong |
| --------------------- | ------------ | ----------------- | ---------- |
| Virtual Thread νΈν™μ„± | β           | β…                | β…         |
| κ³µμ •μ„± λ³΄μ¥           | β           | β… (Fair Lock)    | β         |
| νƒ€μ„μ•„μ›ƒ κΈ°λ¥         | β           | β…                | β         |
| λ³µμ΅ν• λΉ„μ¦λ‹μ¤ λ΅μ§  | β…           | β…                | β         |
| λ½ μƒνƒ λ¨λ‹ν„°λ§      | β           | β…                | β         |

### ν•µμ‹¬ κµ¬ν„ νΉμ§•

- **μ‚¬μ©μλ³„ λ½**: λ‹¤λ¥Έ μ‚¬μ©μλ” λ³‘λ ¬ μ²λ¦¬ κ°€λ¥
- **Fair Lock**: FIFO μμ„λ΅ κ³µμ •ν• μ²λ¦¬
- **μλ™ λ½ μ •λ¦¬**: λ©”λ¨λ¦¬ λ„μ λ°©μ§€λ¥Ό μ„ν• μ¤μΌ€μ¤„λ¬
- **λ½ λ¨λ‹ν„°λ§**: μ‹¤μ‹κ°„ λ½ μƒνƒ ν™•μΈ κ°€λ¥

---

## π’¥ μμ™Έ μ²λ¦¬ μ „λµ

### λ„λ©”μΈ μμ™Έ κ³„μΈµ κµ¬μ΅°

```java
PointException (μ¶”μƒ)
β”β”€β”€ InvalidAmountException     // μ ν¨ν•μ§€ μ•μ€ κΈμ•΅
β”β”€β”€ InsufficientPointException // ν¬μΈνΈ λ¶€μ΅±
β””β”€β”€ ExceedsMaxPointException   // μµλ€ ν¬μΈνΈ μ΄κ³Ό
```

### μμ™Έ μ‘λ‹µ μμ‹

```json
// ν¬μΈνΈ λ¶€μ΅± μ‹
{
  "code": "INSUFFICIENT_POINT",
  "message": "ν¬μΈνΈκ°€ λ¶€μ΅±ν•©λ‹λ‹¤. μ”μ²­: 6000, ν„μ¬: 5000"
}

// μµλ€ ν¬μΈνΈ μ΄κ³Ό μ‹
{
  "code": "EXCEEDS_MAX_POINT",
  "message": "μµλ€ λ³΄μ  κ°€λ¥ ν¬μΈνΈλ” 1,000,000μ›μ…λ‹λ‹¤"
}
```

---

## π§ ν…μ¤νΈ μ „λµ

### κ³„μΈµλ³„ ν…μ¤νΈ μ ‘κ·Ό

- **λ‹¨μ„ ν…μ¤νΈ**: Mock κΈ°λ° κ²©λ¦¬λ ν…μ¤νΈ
- **λ™μ‹μ„± ν…μ¤νΈ**: μ‹¤μ  μ¤λ λ“ ν™κ²½μ—μ„ κ²€μ¦
- **ν†µν•© ν…μ¤νΈ**: Spring Context κΈ°λ° End-to-End ν…μ¤νΈ

### μ£Όμ” ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

```java
@Test
@DisplayName("β… λ™μ‹ μ¶©μ „ μ‹ Lost Update λ¬Έμ  ν•΄κ²°")
void λ™μ‹_μ¶©μ „_Lost_Update_ν•΄κ²°() {
    // 10κ° μ¤λ λ“κ°€ λ™μ‹μ— 100ν¬μΈνΈμ”© μ¶©μ „
    // κΈ°λ€κ°’: 1000 + (10 Γ— 100) = 2000 ν¬μΈνΈ
    // κ²°κ³Ό: μ •ν™•ν 2000 ν¬μΈνΈ (Lost Update μ—†μ)
}
```

### ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€

- **ConcurrencyResolvedTest**: λ™μ‹μ„± λ¬Έμ  ν•΄κ²° κ²€μ¦
- **PointServiceTest**: λΉ„μ¦λ‹μ¤ λ΅μ§ λ‹¨μ„ ν…μ¤νΈ
- **PointControllerTest**: API κ³„μΈµ ν…μ¤νΈ
- **PolicyTest**: λ„λ©”μΈ μ •μ±… κ²€μ¦

---

## π€ μ„±λ¥ λ° ν™•μ¥μ„±

### μ„±λ¥ μµμ ν™”

- **μ‚¬μ©μλ³„ λ³‘λ ¬ μ²λ¦¬**: μ„λ΅ λ‹¤λ¥Έ μ‚¬μ©μλ” λ™μ‹ μ²λ¦¬
- **ConcurrentHashMap**: Lock-free μ½κΈ° μ—°μ‚°
- **λ©”λ¨λ¦¬ κ΄€λ¦¬**: μλ™ λ½ μ •λ¦¬λ΅ λ©”λ¨λ¦¬ λ„μ λ°©μ§€

### λ¨λ‹ν„°λ§ κΈ°λ¥

```java
// μ‹¤μ‹κ°„ λ½ μƒνƒ ν™•μΈ
String status = pointService.getLockStatus();
// "Total Locks: 150, Active Locks: 12, Queue Length: 3"

// λ©”λ¨λ¦¬ μ‚¬μ©λ‰ ν™•μΈ
String memory = pointService.getMemoryInfo();
// "Active Locks: 150, Map Size: 9600 bytes (estimated)"
```

---

## π”§ μ£Όμ” κΈ°λ¥

### ν¬μΈνΈ κ΄€λ¦¬

- **ν¬μΈνΈ μ΅°ν**: μ‚¬μ©μλ³„ ν„μ¬ ν¬μΈνΈ ν™•μΈ
- **ν¬μΈνΈ μ¶©μ „**: λ™μ‹μ„± μ μ–΄λ¥Ό ν†µν• μ•μ „ν• μ¶©μ „
- **ν¬μΈνΈ μ‚¬μ©**: μ”κ³  κ²€μ¦κ³Ό ν•¨κ» μ•μ „ν• μ°¨κ°
- **μ΄λ ¥ μ΅°ν**: μ¶©μ „/μ‚¬μ© λ‚΄μ—­ μ΅°ν

### API μμ‹

```http
# ν¬μΈνΈ μ¶©μ „
PATCH /point/1/charge
Content-Type: application/json
Body: 5000

# μ‘λ‹µ
{
  "id": 1,
  "point": 15000,
  "updateMillis": 1720797823371
}
```

---

## π“¦ κΈ°μ  μ¤νƒ

- **Java 17**
- **Spring Boot 3.2.0**
- **JUnit 5**: ν…μ¤νΈ ν”„λ μ„μ›ν¬
  - **Mockito**: λ¨ν‚Ή λΌμ΄λΈλ¬λ¦¬
  - **MockMvc**: μ›Ή κ³„μΈµ ν…μ¤νΈ
  - **AssertJ**: ν…μ¤νΈ μ–΄μ„¤μ…
- **Gradle**: λΉλ“ λ° μμ΅΄μ„± κ΄€λ¦¬
- **Lombok**: λ³΄μΌλ¬ν”λ μ΄νΈ μ½”λ“ κ°μ†

---

## π― ν•™μµ λ©ν‘ λ‹¬μ„±

### λ™μ‹μ„± μ μ–΄ λ§μ¤ν„°λ¦¬

- β… **Lost Update ν•΄κ²°**: ReentrantLockμΌλ΅ μ™„λ²½ ν•΄κ²°
- β… **Race Condition λ°©μ§€**: μ›μμ  μ—°μ‚° λ³΄μ¥
- β… **λ©”λ¨λ¦¬ μ•μ „μ„±**: μλ™ μ •λ¦¬ λ©”μ»¤λ‹μ¦ κµ¬ν„
- β… **μ„±λ¥ μµμ ν™”**: μ‚¬μ©μλ³„ λ³‘λ ¬ μ²λ¦¬λ΅ ν™•μ¥μ„± ν™•λ³΄

### μ•„ν‚¤ν…μ² μ„¤κ³„

- β… **κ΄€μ‹¬μ‚¬ λ¶„λ¦¬**: κ³„μΈµλ³„ λ…ν™•ν• μ±…μ„ λ¶„λ¦¬
- β… **ν…μ¤νΈ κ°€λ¥μ„±**: Mockκ³Ό Real κ°μ²΄μ μ μ ν• μ΅°ν•©
- β… **μ„¤μ • μ™Έλ¶€ν™”**: μ΄μ ν™κ²½ λ€μ‘ λ¥λ ¥
- β… **ν™•μ¥ κ°€λ¥μ„±**: μƒλ΅μ΄ κΈ°λ¥ μ¶”κ°€ μ‹ μµμ† μν–¥

---

## π’΅ ν•µμ‹¬ κµν›

**"μΆ‹μ€ μ„¤κ³„λ” λ³€κ²½μ— κ°•ν•λ‹¤"**

PointServiceμ λ™μ‹μ„± μ μ–΄ κµ¬ν„μ„ synchronizedμ—μ„ ReentrantLockμΌλ΅ λ³€κ²½ν•΄λ„ **λ€λ¶€λ¶„μ ν…μ¤νΈκ°€ ν†µκ³Ό**ν•λ‹¤λ” κ²ƒμ€:

1. **μΈν„°νμ΄μ¤μ™€ κµ¬ν„μ΄ μ λ¶„λ¦¬**λμ–΄ μκ³ 
2. **ν…μ¤νΈκ°€ κµ¬ν„μ΄ μ•„λ‹ ν–‰μ„λ¥Ό κ²€μ¦**ν•λ©°
3. **κ΄€μ‹¬μ‚¬κ°€ λ…ν™•ν λ¶„λ¦¬**λμ–΄ μλ‹¤λ” μ¦κ±°

νΉν **λ™μ‹μ„± ν…μ¤νΈλ“¤**μ€ λ‚΄λ¶€ λ½ κµ¬ν„ λ°©μ‹κ³Ό λ¬΄κ΄€ν•κ² "λ™μ‹μ„±μ΄ λ³΄μ¥λλ”κ°€?"λΌλ” λ³Έμ§μ  μ§λ¬Έμ—λ§ μ§‘μ¤‘ν•μ—¬ κµ¬ν„ λ³€κ²½μ— κ°•κ±΄ν• ν…μ¤νΈ μ„¤κ³„λ¥Ό λ©ν‘ν•μ€μµλ‹λ‹¤.
